<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Help ðŸ©º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-window {
            height: calc(100vh - 12rem);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-2xl flex flex-col h-full">
        <!-- Header --><div class="p-4 border-b border-gray-700 flex items-center space-x-4 rounded-t-2xl">
            <!-- Logo with Medical Cross Icon --><div class="w-12 h-12 flex-shrink-0 bg-indigo-600 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </div>
            <!-- Title and Subtitle --><div class="text-left">
                <h1 class="text-xl font-bold text-indigo-400">Health Help ðŸ©º</h1>
                <p class="text-sm text-gray-400">Your own Symptom Checker Bot.</p>
            </div>
        </div>


        <!-- Chat Window --><div id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-4">
            <!-- Messages will be injected here --></div>

        <!-- Input Area --><div class="p-4 border-t border-gray-700 rounded-b-2xl">
            <div id="error-box" class="hidden bg-red-900/50 text-red-300 p-3 rounded-lg mb-4 text-sm"></div>
            <div class="flex items-center space-x-4">
                <input type="text" id="user-input" class="flex-1 bg-gray-700 border border-gray-600 rounded-full py-3 px-6 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400" placeholder="Type your message..." autocomplete="off">
                <button id="send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-3 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 0010 16h.008a1 1 0 00.724-.308l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-.832-.247z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const errorBox = document.getElementById('error-box');

        const API_URL = 'http://127.0.0.1:8000/chat';

        let conversationHistory = [];

        // --- Functions to add messages to the UI ---
        const addMessage = (sender, message) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            // A simple markdown to HTML converter for bot messages
            let formattedMessage = message;
            if (sender === 'bot') {
                 // Convert all newlines to <br> first to preserve them
                formattedMessage = formattedMessage.replace(/\n/g, '<br>');
                // Bold: **text** -> <strong>text</strong>
                formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Headers: ### text -> <h3>text</h3>
                formattedMessage = formattedMessage.replace(/### (.*?)(<br>|$)/g, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>');
                // Unordered list: * text -> <li>text</li>, then wrap in <ul>
                formattedMessage = formattedMessage.replace(/<br>\* (.*?)(<br>|$)/g, '<li>$1</li>');
                if (formattedMessage.includes('<li>')) {
                    formattedMessage = `<ul>${formattedMessage.replace(/<\/li><br>/g, '</li>')}</ul>`.replace(/<\/ul><ul>/g, '');
                }
            }


            messageDiv.innerHTML = `
                <div class="max-w-md p-4 rounded-2xl ${sender === 'user' ? 'bg-indigo-600' : 'bg-gray-700'}">
                    <p class="text-white">${formattedMessage}</p>
                </div>
            `;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to bottom
        };

        const showLoadingIndicator = () => {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="max-w-md p-4 rounded-2xl bg-gray-700">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;
            chatWindow.appendChild(loadingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const removeLoadingIndicator = () => {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        };
        
        const showError = (message) => {
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
        };

        const hideError = () => {
            errorBox.classList.add('hidden');
        };


        // --- Main logic ---
        const handleSendMessage = async () => {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            // 1. Display user's message and update history
            addMessage('user', userMessage);
            conversationHistory.push({ role: 'user', content: userMessage });
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;
            hideError();

            // 2. Show loading indicator
            showLoadingIndicator();

            // 3. Send history to backend
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: conversationHistory })
                });

                removeLoadingIndicator();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const botMessage = data.response;

                // 4. Display bot's response and update history
                addMessage('bot', botMessage);
                conversationHistory.push({ role: 'model', content: botMessage });

            } catch (error) {
                console.error("Fetch error:", error);
                removeLoadingIndicator();
                showError(`Sorry, an error occurred: ${error.message}. Please check if the backend is running.`);
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        };

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });

        // --- Initial message from bot ---
        const addInitialBotMessage = () => {
            const initialMessage = "Hello! I'm Health Help, your friendly AI assistant. To start, please tell me about the main symptom you're experiencing.";
            addMessage('bot', initialMessage);
            // The initial message should come from the model, so we add it to the history
            conversationHistory.push({ role: 'model', content: initialMessage });
        };

        window.onload = addInitialBotMessage;

    </script>
</body>
</html>

